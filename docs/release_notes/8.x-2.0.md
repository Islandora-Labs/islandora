# 8.x-2.0 Release Notes

## Update to PHP 7.4

Downstream dependencies have forced us to upgrade PHP to 7.4.  How to do this varies by operating system, but for Ubuntu 18.04 the following will work:

- `sudo apt install software-properties-common`
- `sudo add-apt-repository ppa:ondrej/php`
- `sudo apt update`
- `sudo apt install php7.4`
- `sudo apt install php7.4-curl php7.4-xml php7.4-gd php7.4-imap php7.4-mbstring php7.4-mysql`

## Update PHP code

To get the latest PHP code, edit your `composer.json` file and change the `islandora/*` packages versions' to `2.0.0`.  Then run the following command to update them, your dependencies, and Drupal core: `sudo php -d memory_limit=-1 `which composer` update --with-all-dependencies`

## Media File Size Schema Change
The size value for media was too small to support large files (>2.2 GB). This release includes an update that allows values up to 16 exabytes. This requires existing sites updating their islandora/islandora to run a Drupal update (either `drush updb` or visit `/update.php` in your browser).  This may take a few minutes to run depending on how many media your site has.

## Removing Gemini
It is recommended to test this method in a staging/development environment before running in your production environment.
1. Update islandora core (likely through a command like `composer update islandora/islandora`)
2. Import two new Islandora views

    i. This can be done by coping the views into a new directory and using drush such as 
    ```
    mkdir /var/www/html/drupal/config/1time
    cp /var/www/html/drupal/web/modules/contrib/islandora/modules/islandora_core_feature/config/install/views.view.all_taxonomy_terms.yml /var/www/html/drupal/config/1time/
    cp /var/www/html/drupal/web/modules/contrib/islandora/modules/islandora_core_feature/config/install/views.view.non_fedora_files.yml /var/www/html/drupal/config/1time/
    drush config:import --partial --source /var/www/html/drupal/config/1time
    ```
    ii. It can also be done through the UI at `/admin/config/development/configuration/single/import`
3. Update crayfish-commons for drupal with something like `cd /var/www/html/drupal && composer update islandora/crayfish-commons`
4. Update Crayfish code (likely by traversing to your crayfish installation and doing a git pull `cd /var/www/html/Crayfish && git pull`)
5. Run composer install for Milliner such as `cd /var/www/html/Crayfish/Milliner && composer install`
6. Run composer install for Recast such as `cd /var/www/html/Crayfish/Recast && composer install`
7. Update the Recast config 

    i. `cd /var/www/html/Crayfish/Recast/cfg`
    ii. open `config.yaml`
    iii. Remove `gemini_base_url`
    iv. Update `base_url` in `fedora_resource` section. It should contain a value something like `http://localhost:8080/fcrepo/rest`
8. Clear your cache in Drupal. Potentially like `cd /var/www/html/drupal && drush cr`
9. Restart apache (not 100% sure if this is necesssary) `sudo systemctl restart apache2`
9. Test to make sure you can view existing objects in Fedora by going to the Drupal UI and clicking one of the Fedora URI links
10. Create a new object and make sure it persists to Fedora and the Fedora URI likn resolves correctly. Make sure that no new entries get added to Gemini.
11. If you're feeling brave, you can then remove Gemini like
    i. `rm /var/www/html/Crayfish/Gemini`
    ii. Remove the gemini database and the associated mysql user


## Adding Captions
1. Make sure you are on the most recent code of islandora and islandora_defaults (`composer update islandora/islandora islandora/islandora_defaults`)
2. Do a config import on the `config/install` directory of `islandora_defaults` or copy the changed files into another directory and import those (if you are on an existing install, i'd recommend the partial config import). The changed files are:
    i. core.entity_form_display.media.audio.default
    ii. core.entity_form_display.media.video.default
    iii. core.entity_view_display.media.audio.default
    iv. core.entity_view_display.media.audio.source
    v. core.entity_view_display.media.video.default
    vi. core.entity_view_display.media.video.source
    vii. field.field.media.audio.field_track
    viii. field.field.media.video.field_track
    ix. field.storage.media.field_track
3. clear your drupal cache `drush cr`
4. You should now see a "track" field on audio and video media objects
